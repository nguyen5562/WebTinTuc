@model WebTinTuc.Models.NguoiDung
@{
    ViewData["Title"] = "Thông tin cá nhân";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 mt-4">
                <div class="card-header bg-info text-white text-center py-4">
                    <h3 class="mb-0">
                        <i class="fas fa-user-circle me-2"></i>Thông tin cá nhân
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            @if (!string.IsNullOrEmpty(Model.UrlanhDaiDien))
                            {
                                <img src="@Model.UrlanhDaiDien" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;" alt="Ảnh đại diện">
                            }
                            else
                            {
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mb-3 mx-auto" style="width: 150px; height: 150px;">
                                    <i class="fas fa-user fa-4x text-muted"></i>
                                </div>
                            }
                            <h5 class="text-primary">@Model.HoTen</h5>
                            <span class="badge bg-primary fs-6">@Model.IdquyenHanNavigation?.TenQuyenHan</span>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-user me-1"></i>Họ và tên
                                        </label>
                                        <p class="form-control-plaintext">@Model.HoTen</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-envelope me-1"></i>Email
                                        </label>
                                        <p class="form-control-plaintext">@Model.Email</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-phone me-1"></i>Số điện thoại
                                        </label>
                                        <p class="form-control-plaintext">@(Model.SoDienThoai ?? "Chưa cập nhật")</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-user-tag me-1"></i>Quyền hạn
                                        </label>
                                        <p class="form-control-plaintext">@Model.IdquyenHanNavigation?.TenQuyenHan</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-calendar-plus me-1"></i>Ngày đăng ký
                                        </label>
                                        <p class="form-control-plaintext">@Model.NgayDangKy.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-clock me-1"></i>Lần đăng nhập cuối
                                        </label>
                                        <p class="form-control-plaintext">
                                            @if (Model.LanDangNhapCuoi.HasValue)
                                            {
                                                @Model.LanDangNhapCuoi.Value.ToString("dd/MM/yyyy HH:mm")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chưa có</span>
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-toggle-on me-1"></i>Trạng thái tài khoản
                                </label>
                                <p class="form-control-plaintext">
                                    @if (Model.DaKichHoat == true)
                                    {
                                        <span class="badge bg-success">Đã kích hoạt</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Chưa kích hoạt</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-newspaper fa-2x text-primary mb-2"></i>
                                    <h6 class="card-title">Bài viết đã xuất bản</h6>
                                    <p class="card-text fs-4 text-primary fw-bold">@ViewBag.PublishedArticlesCount</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-comments fa-2x text-success mb-2"></i>
                                    <h6 class="card-title">Bình luận đã duyệt</h6>
                                    <p class="card-text fs-4 text-success fw-bold">@ViewBag.ApprovedCommentsCount</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-edit fa-2x text-warning mb-2"></i>
                                    <h6 class="card-title">Bài viết bản nháp</h6>
                                    <p class="card-text fs-4 text-warning fw-bold">@ViewBag.DraftArticlesCount</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                    <h6 class="card-title">Bài viết chờ duyệt</h6>
                                    <p class="card-text fs-4 text-info fw-bold">@ViewBag.PendingArticlesCount</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bài viết gần đây -->
                    @if (ViewBag.RecentArticles != null && ((List<WebTinTuc.Models.BaiViet>)ViewBag.RecentArticles).Any())
                    {
                        <hr class="my-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-history me-2"></i>Bài viết gần đây
                        </h5>
                        <div class="row">
                            @foreach (var article in (List<WebTinTuc.Models.BaiViet>)ViewBag.RecentArticles)
                            {
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <a href="/BaiViet/@article.Slug" class="text-decoration-none">
                                                    @article.TieuDe
                                                </a>
                                            </h6>
                                            <p class="card-text text-muted small">
                                                <i class="fas fa-calendar me-1"></i>
                                                @article.NgayTao.Value.ToString("dd/MM/yyyy HH:mm")
                                                <span class="badge bg-@(article.IdtrangThaiNavigation.TenTrangThai == "Đã xuất bản" ? "success" : 
                                                                    article.IdtrangThaiNavigation.TenTrangThai == "Chờ duyệt" ? "warning" : 
                                                                    article.IdtrangThaiNavigation.TenTrangThai == "Bản nháp" ? "secondary" : "danger") ms-2">
                                                    @article.IdtrangThaiNavigation.TenTrangThai
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="fas fa-edit me-1"></i>Chỉnh sửa thông tin
                        </button>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Quay lại trang chủ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chỉnh sửa thông tin -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Chỉnh sửa thông tin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="editHoTen" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editHoTen" name="hoTen" value="@Model.HoTen" required>
                        <div class="invalid-feedback">Vui lòng nhập họ tên!</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSoDienThoai" class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-control" id="editSoDienThoai" name="soDienThoai" value="@Model.SoDienThoai" placeholder="0123456789">
                        <div class="form-text">Số điện thoại là tùy chọn</div>
                    </div>
                    <div class="mb-3">
                        @await Html.PartialAsync("_ImageUpload", Model.UrlanhDaiDien, new ViewDataDictionary(ViewData) {
                            { "FieldId", "editAnhDaiDien" },
                            { "FieldName", "urlAnhDaiDien" },
                            { "Label", "URL ảnh đại diện" },
                            { "Placeholder", "https://example.com/avatar.jpg" },
                            { "HelpText", "URL ảnh đại diện là tùy chọn" }
                        })
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveProfileBtn">
                    <i class="fas fa-save me-1"></i>Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Function hiển thị thông báo
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Xử lý nút lưu thông tin
        document.getElementById('saveProfileBtn').addEventListener('click', function() {
            const form = document.getElementById('editProfileForm');
            const formData = new FormData(form);
            const saveBtn = this;
            const originalText = saveBtn.innerHTML;
            
            // Validation
            const hoTen = document.getElementById('editHoTen').value.trim();
            if (!hoTen || hoTen.length < 2) {
                if (hasUserInteracted) {
                    showNotification('Họ tên phải có ít nhất 2 ký tự!', 'error');
                }
                document.getElementById('editHoTen').classList.add('is-invalid');
                return;
            }
            
            // Disable button và hiển thị loading
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...';
            
            fetch('@Url.Action("UpdateProfile", "Account")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Đóng modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                    modal.hide();
                    // Reload trang để cập nhật thông tin
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(data.message, 'error');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                showNotification('Có lỗi xảy ra khi cập nhật thông tin!', 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });
        });

        // Xử lý khi modal được đóng
        document.getElementById('editProfileModal').addEventListener('hidden.bs.modal', function() {
            // Reset form về trạng thái ban đầu
            document.getElementById('editProfileForm').reset();
            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Lưu thay đổi';
        });

        // Flag để track xem user đã tương tác với form chưa
        let hasUserInteracted = false;
        
        // Validation real-time cho form
        document.getElementById('editHoTen').addEventListener('input', function() {
            hasUserInteracted = true;
            const value = this.value.trim();
            if (value.length < 2) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Validation cho URL ảnh đại diện
        document.getElementById('editAnhDaiDien').addEventListener('input', function() {
            hasUserInteracted = true;
            const value = this.value.trim();
            if (value && !isValidUrl(value)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
    </script>
    
    <style>
        .profile-avatar {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        
        .is-invalid + .invalid-feedback {
            display: block;
        }
        
        .profile-info-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .profile-info-item:last-child {
            border-bottom: none;
        }
        
        .profile-info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        .profile-info-value {
            color: #6c757d;
        }
        
        .modal-body .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .is-invalid {
            border-color: #dc3545;
        }
        
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
    </style>
}
