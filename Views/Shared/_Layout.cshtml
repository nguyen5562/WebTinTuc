<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - WebTinTuc</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WebTinTuc.styles.css" asp-append-version="true" />
    <!-- Font Awesome with integrity check -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer" />
</head>
<body>
    <header>
        <!-- Top Header -->
        <div class="top-header text-white py-2">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="d-flex align-items-center">
                            <i class="fas fa-calendar-alt me-2"></i> 
                            <span>@DateTime.Now.ToString("dddd, dd/MM/yyyy")</span>
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex align-items-center justify-content-end gap-3">
                            <small class="d-flex align-items-center">
                                <i class="fas fa-phone me-1"></i> 
                                <span>Hotline: 1900-xxxx</span>
                            </small>
                            <div class="d-flex gap-2">
                                <a href="#" class="text-white opacity-75 hover:opacity-100 transition-opacity">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="text-white opacity-75 hover:opacity-100 transition-opacity">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="#" class="text-white opacity-75 hover:opacity-100 transition-opacity">
                                    <i class="fab fa-youtube"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container">
                <a class="navbar-brand fw-bold fs-3 text-gradient" asp-area="" asp-controller="Home" asp-action="Index">
                    <i class="fas fa-newspaper me-2"></i>WebTinTuc
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link fw-semibold" asp-area="" asp-controller="Home" asp-action="Index">
                                <i class="fas fa-home me-1"></i>Trang chủ
                            </a>
                        </li>
                    </ul>
                    
                    <div class="d-flex align-items-center">
                        <div class="search-container me-3" style="width: 320px;">
                            <form method="get" asp-controller="Search" asp-action="Index" class="d-flex">
                                <div class="position-relative flex-grow-1">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="form-control" name="q" placeholder="Tìm kiếm tin tức..." value="@ViewBag.SearchQuery">
                                </div>
                                <button class="btn btn-primary ms-2" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>
                        
                        @if (Context.Session.GetString("UserId") != null)
                        {
                            <!-- User đã đăng nhập -->
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                            <i class="fas fa-user fa-sm"></i>
                                        </div>
                                        <span class="d-none d-lg-inline">@Context.Session.GetString("UserName")</span>
                                    </div>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-xl" style="z-index: 1055; min-width: 250px;">
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-user-circle me-1"></i>@Context.Session.GetString("UserName")
                                        </h6>
                                    </li>
                                    <li>
                                        <span class="dropdown-item-text">
                                            <i class="fas fa-envelope me-1"></i>@Context.Session.GetString("UserEmail")
                                        </span>
                                    </li>
                                    <li>
                                        <span class="dropdown-item-text">
                                            <i class="fas fa-user-tag me-1"></i>@Context.Session.GetString("UserRole")
                                        </span>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                                            <i class="fas fa-user-edit me-1"></i>Thông tin cá nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-dark" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                            <i class="fas fa-key me-1"></i>Đổi mật khẩu
                                        </a>
                                    </li>
                                    @if (Context.Session.GetString("UserRole") == "Tác giả" || Context.Session.GetString("UserRole") == "Quản trị")
                                    {
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="BaiViet" asp-action="Create">
                                                <i class="fas fa-edit me-1"></i>Viết bài
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="BaiViet" asp-action="Manage">
                                                <i class="fas fa-list me-1"></i>Quản lý bài viết
                                            </a>
                                        </li>
                                    }
                                    @if (Context.Session.GetString("UserRole") == "Quản trị")
                                    {
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Admin" asp-action="Index">
                                                <i class="fas fa-cogs me-1"></i>Quản trị hệ thống
                                            </a>
                                        </li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" asp-controller="Account" asp-action="Logout">
                                            <i class="fas fa-sign-out-alt me-1"></i>Đăng xuất
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <!-- User chưa đăng nhập -->
                            <div class="d-flex gap-2">
                                <a class="btn btn-outline-primary btn-sm" asp-controller="Account" asp-action="Login">
                                    <i class="fas fa-sign-in-alt me-1"></i>
                                    <span class="d-none d-md-inline">Đăng nhập</span>
                                </a>
                                <a class="btn btn-primary btn-sm" asp-controller="Account" asp-action="Register">
                                    <i class="fas fa-user-plus me-1"></i>
                                    <span class="d-none d-md-inline">Đăng ký</span>
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Menu chủ đề nằm ngang -->
        <div class="category-menu">
            <div class="container">
                <nav class="navbar navbar-expand-lg navbar-light py-3">
                    <div class="navbar-nav flex-row flex-wrap justify-content-center w-100">
                        @{
                            var chuDes = ViewBag.ChuDes as List<WebTinTuc.Models.ChuDe>;
                        }
                        @if (chuDes != null && chuDes.Any())
                        {
                            @foreach (var chuDe in chuDes)
                            {
                                <a class="nav-link hover-lift" href="/ChuDe/@chuDe.Slug">
                                    <i class="fas fa-tag me-1"></i>
                                    @chuDe.TenChuDe
                                </a>
                            }
                        }
                        else
                        {
                            <!-- Fallback nếu không có dữ liệu -->
                            <a class="nav-link hover-lift" href="#">
                                <i class="fas fa-tag me-1"></i>THỜI SỰ
                            </a>
                            <a class="nav-link hover-lift" href="#">
                                <i class="fas fa-tag me-1"></i>THẾ GIỚI
                            </a>
                            <a class="nav-link hover-lift" href="#">
                                <i class="fas fa-tag me-1"></i>KINH DOANH
                            </a>
                            <a class="nav-link hover-lift" href="#">
                                <i class="fas fa-tag me-1"></i>GIẢI TRÍ
                            </a>
                            <a class="nav-link hover-lift" href="#">
                                <i class="fas fa-tag me-1"></i>THỂ THAO
                            </a>
                        }
                    </div>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Thông báo TempData -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: #d4edda !important; color: #155724 !important; border: 1px solid #c3e6cb !important;">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: #f8d7da !important; color: #721c24 !important; border: 1px solid #f5c6cb !important;">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: #d1ecf1 !important; color: #0c5460 !important; border: 1px solid #bee5eb !important;">
            <i class="fas fa-info-circle me-2"></i>@TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: #fff3cd !important; color: #856404 !important; border: 1px solid #ffeaa7 !important;">
            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    <div class="container-fluid px-0">
        <main role="main" class="pb-5">
            @RenderBody()
        </main>
    </div>

    <footer class="bg-dark text-light py-5 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="mb-3">
                        <i class="fas fa-newspaper me-2"></i>WebTinTuc
                    </h5>
                    <p class="opacity-75 mb-4">Trang tin tức hàng đầu Việt Nam, cung cấp thông tin nhanh chóng, chính xác và đáng tin cậy.</p>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-decoration-none p-2 rounded-circle bg-primary bg-opacity-10 hover-lift">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="text-decoration-none p-2 rounded-circle bg-primary bg-opacity-10 hover-lift">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-decoration-none p-2 rounded-circle bg-primary bg-opacity-10 hover-lift">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" class="text-decoration-none p-2 rounded-circle bg-primary bg-opacity-10 hover-lift">
                            <i class="fab fa-youtube"></i>
                        </a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-3">Chủ đề</h6>
                    @{
                        var chuDesFooter = ViewBag.ChuDes as List<WebTinTuc.Models.ChuDe>;
                    }
                    @if (chuDesFooter != null && chuDesFooter.Any())
                    {
                        <div class="row">
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    @foreach (var chuDe in chuDesFooter.Take((chuDesFooter.Count + 1) / 2))
                                    {
                                        <li>
                                            <a href="/ChuDe/@chuDe.Slug" 
                                               class="text-muted text-decoration-none">@chuDe.TenChuDe</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    @foreach (var chuDe in chuDesFooter.Skip((chuDesFooter.Count + 1) / 2))
                                    {
                                        <li>
                                            <a href="/ChuDe/@chuDe.Slug" 
                                               class="text-muted text-decoration-none">@chuDe.TenChuDe</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Fallback nếu không có dữ liệu -->
                        <div class="row">
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    <li><a href="#" class="text-muted text-decoration-none">Thời sự</a></li>
                                    <li><a href="#" class="text-muted text-decoration-none">Thế giới</a></li>
                                    <li><a href="#" class="text-muted text-decoration-none">Kinh doanh</a></li>
                                </ul>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    <li><a href="#" class="text-muted text-decoration-none">Giải trí</a></li>
                                    <li><a href="#" class="text-muted text-decoration-none">Thể thao</a></li>
                                    <li><a href="#" class="text-muted text-decoration-none">Công nghệ</a></li>
                                </ul>
                            </div>
                        </div>
                    }
                </div>
                <div class="col-md-4">
                    <h6 class="mb-3">Liên hệ</h6>
                    <ul class="list-unstyled opacity-75">
                        <li class="mb-2">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            123 Đường ABC, Quận XYZ, TP.HCM
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-phone me-2 text-primary"></i>
                            Hotline: 1900-xxxx
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-envelope me-2 text-primary"></i>
                            Email: contact@webtintuc.com
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-muted mb-0">&copy; 2025 WebTinTuc. Tất cả quyền được bảo lưu.</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="#" class="text-muted text-decoration-none me-3">Chính sách bảo mật</a>
                    <a href="#" class="text-muted text-decoration-none">Điều khoản sử dụng</a>
                </div>
            </div>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <!-- Auto-hide alerts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide alerts after 5 seconds
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    if (alert.parentNode) {
                        alert.classList.remove('show');
                        setTimeout(function() {
                            if (alert.parentNode) {
                                alert.parentNode.removeChild(alert);
                            }
                        }, 150); // Wait for fade animation
                    }
                }, 2000);
            });
            
            // Password Toggle Handlers
            function setupPasswordToggle(buttonId, inputId) {
                const button = document.getElementById(buttonId);
                const input = document.getElementById(inputId);
                const icon = button.querySelector('i');
                
                if (button && input) {
                    button.addEventListener('click', function() {
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            input.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    });
                }
            }
            
            // Setup password toggles
            setupPasswordToggle('toggleCurrentPassword', 'currentPassword');
            setupPasswordToggle('toggleNewPassword', 'newPassword');
            setupPasswordToggle('toggleConfirmPassword', 'confirmPassword');
            
            // Change Password Form Handler
            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // Validate passwords match
                    if (newPassword !== confirmPassword) {
                        showNotification('Mật khẩu mới và xác nhận mật khẩu không khớp!', 'error');
                        return;
                    }
                    
                    // Validate password length
                    if (newPassword.length < 6) {
                        showNotification('Mật khẩu mới phải có ít nhất 6 ký tự!', 'error');
                        return;
                    }
                    
                    // Submit form
                    const formData = new FormData();
                    formData.append('currentPassword', currentPassword);
                    formData.append('newPassword', newPassword);
                    formData.append('confirmPassword', confirmPassword);
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                    
                    fetch('@Url.Action("ChangePassword", "Account")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            // Close modal and reset form
                            const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                            modal.hide();
                            changePasswordForm.reset();
                            // Reset password visibility
                            resetPasswordVisibility();
                        } else {
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showNotification('Có lỗi xảy ra khi đổi mật khẩu!', 'error');
                    });
                });
            }
            
            // Reset password visibility when modal is closed
            function resetPasswordVisibility() {
                const inputs = ['currentPassword', 'newPassword', 'confirmPassword'];
                const buttons = ['toggleCurrentPassword', 'toggleNewPassword', 'toggleConfirmPassword'];
                
                inputs.forEach((inputId, index) => {
                    const input = document.getElementById(inputId);
                    const button = document.getElementById(buttons[index]);
                    const icon = button.querySelector('i');
                    
                    if (input && button && icon) {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }
            
            // Reset password visibility when modal is hidden
            document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
                resetPasswordVisibility();
            });
        });
        
        // Global notification function
        function showNotification(message, type) {
            let alertClass, iconClass, bgColor, textColor, borderColor;
            
            if (type === 'success') {
                alertClass = 'alert-success';
                iconClass = 'fa-check-circle';
                bgColor = '#d4edda';
                textColor = '#155724';
                borderColor = '#c3e6cb';
            } else {
                alertClass = 'alert-danger';
                iconClass = 'fa-exclamation-circle';
                bgColor = '#f8d7da';
                textColor = '#721c24';
                borderColor = '#f5c6cb';
            }
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: ${bgColor} !important; color: ${textColor} !important; border: 1px solid ${borderColor} !important;" role="alert">
                    <i class="fas ${iconClass} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
        }
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)
    
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="fas fa-key me-2"></i>Đổi mật khẩu
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="changePasswordForm">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Mật khẩu hiện tại <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Mật khẩu phải có ít nhất 6 ký tự</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Đổi mật khẩu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <style>
        /* Dropdown submenu */
    </style>
</body>
</html>

